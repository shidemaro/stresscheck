<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ストレスチェック</title>
  <style>
    body {
      font-family: 'Noto Sans JP', 'Segoe UI', sans-serif;
      background-color: #f9f9f9;
      color: #333;
      margin: 0;
      padding: 20px;
      font-size: 16px;
      line-height: 1.5;
    }
    header, footer {
      background-color: #007bff;
      color: white;
      text-align: center;
      padding: 10px 0;
    }
    main {
      max-width: 800px;
      margin: auto;
    }
    .question {
      margin-bottom: 20px;
    }
    .options label {
      margin-right: 15px;
      display: inline-block;
      margin-bottom: 10px;
    }
    .submit-button {
      margin-top: 20px;
      padding: 12px 24px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      min-width: 120px;
      font-size: 16px;
    }
    .submit-button:hover {
      background-color: #0056b3;
    }
    .results {
      margin-top: 30px;
      font-weight: bold;
    }
    input[type="text"], input[type="password"] {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 16px;
    }
    input[type="radio"], input[type="checkbox"] {
      margin-right: 8px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f0f0f0;
    }
    .table-wrapper {
      overflow-x: auto;
    }
    .high-stress {
      color: red;
      font-weight: bold;
    }
    .filter-button {
      margin: 10px 0;
      padding: 8px 16px;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    @media (max-width: 480px) {
      body {
        padding: 10px;
        font-size: 14px;
      }
      .submit-button, .filter-button {
        padding: 10px 20px;
        min-width: 100px;
      }
      input[type="text"], input[type="password"] {
        padding: 8px;
      }
      .question {
        margin-bottom: 15px;
      }
      th, td {
        padding: 6px;
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>ストレスチェック</h1>
  </header>

  <main>
    <section id="intro">
      <p>簡単なストレスチェックを実施できます。年度ごとに1回のみ提出可能です。</p>
      <form id="login-form">
        <input type="text" id="company" placeholder="会社名" required aria-label="会社名">
        <input type="password" id="password" placeholder="パスワード" required aria-label="パスワード">
        <input type="text" id="username" placeholder="氏名（個人用のみ）" aria-label="氏名">
        <label><input type="checkbox" id="adminCheck"> 管理者ログイン</label><br>
        <button type="submit" class="submit-button">ログイン</button>
      </form>
    </section>

    <section id="checklist" style="display:none;">
      <form id="stressForm">
        <h2>A. 仕事について</h2>
        <div id="sectionA"></div>
        <h2>B. 最近の状態</h2>
        <div id="sectionB"></div>
        <h2>C. 周囲との関係</h2>
        <div id="sectionC"></div>
        <h2>D. 満足度について</h2>
        <div id="sectionD"></div>
        <button type="submit" class="submit-button">送信</button>
      </form>
      <div id="result" class="results"></div>
      <button id="downloadPDF" class="submit-button">PDFとして保存</button>
    </section>

    <section id="adminPanel" style="display:none;">
      <h2>管理画面</h2>
      <button id="filterHighStress" class="filter-button">高ストレス者のみ表示</button>
      <div class="table-wrapper">
        <div id="adminResults"></div>
      </div>
      <button id="exportCSV" class="submit-button">CSVダウンロード</button>
    </section>

    <section id="adminMaster" style="display:none; margin: 20px;">
      <h2>マスターログイン</h2>
      <p>全会社の回答データを表示します。</p>
      <button id="filterHighStressMaster" class="filter-button">高ストレス者のみ表示</button>
      <div class="table-wrapper">
        <div id="masterResults"></div>
      </div>
      <button id="exportAllCSV" class="submit-button">すべてCSVダウンロード</button>
    </section>

    <section id="masterPasswordPanel" style="display:none; margin: 20px;">
      <h2>管理者パスワード一覧</h2>
      <p>全会社の管理者パスワードと関連する個人名を表示します。</p>
      <div class="table-wrapper">
        <div id="masterPasswordResults"></div>
      </div>
    </section>
  </main>

  <footer>
    <p>© 2025 ストレスチェックシステム | <a href="/privacy.html">プライバシーポリシー</a></p>
  </footer>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const loginForm = document.getElementById('login-form');
      const checklist = document.getElementById('checklist');
      const adminPanel = document.getElementById('adminPanel');
      const adminMaster = document.getElementById('adminMaster');
      const masterPasswordPanel = document.getElementById('masterPasswordPanel');
      const stressForm = document.getElementById('stressForm');
      const resultDiv = document.getElementById('result');
      const sectionA = document.getElementById('sectionA');
      const sectionB = document.getElementById('sectionB');
      const sectionC = document.getElementById('sectionC');
      const sectionD = document.getElementById('sectionD');
      const adminResults = document.getElementById('adminResults');
      const masterResults = document.getElementById('masterResults');
      const masterPasswordResults = document.getElementById('masterPasswordResults');

      const A_questions = [
        "非常にたくさんの仕事をしなければならない",
        "時間内に仕事が処理しきれない",
        "一生懸命働かなければならない",
        "かなり注意を集中する必要がある",
        "高度の知識や技術が必要なむずかしい仕事だ",
        "勤務時間中はいつも仕事のことを考えていなければならない",
        "からだを大変よく使う仕事だ",
        "自分のペースで仕事ができる",
        "自分で仕事の順番・やり方を決めることができる",
        "職場の仕事の方針に自分の意見を反映できる",
        "自分の技能や知識を仕事で使うことが少ない",
        "私の部署内で意見のくい違いがある",
        "私の部署と他の部署とはうまが合わない",
        "私の職場の雰囲気は友好的である",
        "私の職場の作業環境（騒音、照明、温度、換気など）はよくない",
        "仕事の内容は自分にあっている",
        "働きがいのある仕事だ"
      ];
      const B_questions = [
        "活気がわいてくる",
        "元気がいっぱいだ",
        "生き生きする",
        "怒りを感じる",
        "内心腹立たしい",
        "イライラしている",
        "ひどく疲れた",
        "へとへとだ",
        "だるい",
        "気がはりつめている",
        "不安だ",
        "落着かない",
        "ゆううつだ",
        "何をするのも面倒だ",
        "物事に集中できない",
        "気分が晴れない",
        "仕事が手につかない",
        "悲しいと感じる",
        "めまいがする",
        "体のふしぶしが痛む",
        "頭が重かったり頭痛がする",
        "首筋や肩がこる",
        "腰が痛い",
        "目が疲れる",
        "動悸や息切れがする",
        "胃腸の具合が悪い",
        "食欲がない",
        "便秘や下痢をする",
        "よく眠れない"
      ];
      const C_questions = [
        "上司（気軽に話ができますか）",
        "職場の同僚（気軽に話ができますか）",
        "配偶者、家族、友人等（気軽に話ができますか）",
        "上司（困った時に頼りになりますか）",
        "職場の同僚（困った時に頼りになりますか）",
        "配偶者、家族、友人等（困った時に頼りになりますか）",
        "上司（個人的な問題を相談したらきいてくれますか）",
        "職場の同僚（個人的な問題を相談したらきいてくれますか）",
        "配偶者、家族、友人等（個人的な問題を相談したらきいてくれますか）"
      ];
      const D_questions = ["仕事に満足だ", "家庭生活に満足だ"];

      function renderQuestions(section, questions, prefix, labels) {
        section.innerHTML = '';
        questions.forEach((q, idx) => {
          const div = document.createElement('div');
          div.className = 'question';
          const qNum = idx + 1;
          div.innerHTML = `<p>${q}</p>` + labels.map((label, i) =>
            `<label><input type="radio" name="${prefix}${qNum}" value="${i+1}" required>${label}</label>`
          ).join(' ');
          section.appendChild(div);
        });
      }

      function loadPasswordData() {
        let html = "<table border='1' style='width:100%;border-collapse:collapse;'>" +
                   "<tr><th>会社名</th><th>管理者パスワード</th><th>個人名</th></tr>";
        let companies = new Set();
        let companyData = {};

        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key.startsWith('adminpass_')) {
            const company = key.replace('adminpass_', '');
            companies.add(company);
            companyData[company] = { password: localStorage.getItem(key), users: new Set() };
          }
        }

        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key.startsWith('stress_')) {
            const item = JSON.parse(localStorage.getItem(key));
            if (item.company && companyData[item.company]) {
              companyData[item.company].users.add(item.name);
            }
          }
        }

        for (const company of companies) {
          const password = companyData[company].password || '未設定';
          const users = Array.from(companyData[company].users).join(', ') || 'なし';
          html += `<tr><td>${company}</td><td>${password}</td><td>${users}</td></tr>`;
        }
        html += "</table>";

        masterPasswordResults.innerHTML = html;
      }

      // ストレスフォームのイベントリスナーをグローバルに定義
      stressForm.addEventListener('change', () => {
        console.log('ストレスフォーム変更検知');
        const formData = new FormData(stressForm);
        const answerData = {};
        for (let [key, value] of formData.entries()) {
          answerData[key] = value;
        }
        localStorage.setItem('autosave', JSON.stringify(answerData));
      });

      stressForm.addEventListener('submit', function(e) {
        e.preventDefault();
        console.log('ストレスフォーム送信');
        const formData = new FormData(stressForm);
        let totalA = 0, totalB = 0, totalC = 0, totalD = 0;
        for (let [key, value] of formData.entries()) {
          const score = parseInt(value);
          const section = key.charAt(0);
          if (section === 'A') totalA += score;
          else if (section === 'B') totalB += score;
          else if (section === 'C') totalC += score;
          else if (section === 'D') totalD += score;
        }
        // 修正: 変数名をlet-evaluationからlet evaluationに変更
        let evaluation = "";
        let highStressFlag = false;
        let highStressReason = "";
        if (totalB >= 77) {
          highStressReason = "B項目（最近の状態）の合計が77点以上";
          evaluation += `<br><span style='color:red;'>[高ストレス該当] ${highStressReason}</span>`;
          highStressFlag = true;
        } else if ((totalA + totalC) >= 76 && totalB >= 63) {
          highStressReason = "A+C（仕事と人間関係）の合計が76点以上かつB（最近の状態）が63点以上";
          evaluation += `<br><span style='color:red;'>[高ストレス該当] ${highStressReason}</span>`;
          highStressFlag = true;
        }

        let guidance = "";
        if (highStressFlag) {
          guidance = "<p style='color:darkred;'><strong>あなたは高ストレスの可能性があります。以下の理由で産業医との面談をおすすめします：<br>" +
                    `- ${highStressReason}<br>` +
                    "面談はメンタルヘルスをサポートし、職場環境の改善に役立ちます。希望する場合はチェックしてください（任意）。</strong></p>" +
                    "<label><input type='checkbox' id='interview' name='interview' value='希望する'> 産業医面談を希望する</label>";
        }

        const explanation = "<p><strong>スコアの意味：</strong><br>" +
                           "- A項目（仕事）：職場の負担や裁量を評価。高いほど仕事のストレスが多い。<br>" +
                           "- B項目（最近の状態）：心身の健康状態。高いほどストレス症状が強い。<br>" +
                           "- C項目（周囲との関係）：社会的支援。低いほど孤立感が強い。<br>" +
                           "- D項目（満足度）：仕事や生活の満足度。低いほど不満が多い。<br>" +
                           "高ストレスと判定された場合、産業医面談で具体的な対策を相談できます。</p>";

        resultDiv.innerHTML =
          `A項目合計: ${totalA}点<br>B項目合計: ${totalB}点<br>C項目合計: ${totalC}点<br>D項目合計: ${totalD}点<br><br>` +
          `<strong>${evaluation}</strong><br>${guidance}<br>${explanation}`;

        const interview = document.getElementById('interview')?.checked ? '希望する' : '';
        const data = {
          company: stressForm.dataset.company,
          name: stressForm.dataset.username,
          year: parseInt(stressForm.dataset.year),
          totalA,
          totalB,
          totalC,
          totalD,
          interview,
          highStress: highStressFlag,
          highStressReason,
          timestamp: new Date().toISOString()
        };
        localStorage.setItem(`stress_${data.company}_${data.name}_${data.year}`, JSON.stringify(data));

        localStorage.removeItem('autosave');
      });

      loginForm.addEventListener('submit', function(e) {
        e.preventDefault();
        console.log('ログイン処理開始');
        const company = document.getElementById('company').value.trim();
        const password = document.getElementById('password').value.trim();
        const username = document.getElementById('username').value.trim();
        const isAdmin = document.getElementById('adminCheck').checked;

        if (company === 'master' && password === 'sakaue0000m') {
          console.log('マスターログイン（パスワード一覧）');
          loginForm.style.display = 'none';
          masterPasswordPanel.style.display = 'block';
          loadPasswordData();
          return;
        }

        if (company === 'master' && password === 'masterpass') {
          console.log('マスターログイン（全データ）');
          loginForm.style.display = 'none';
          adminMaster.style.display = 'block';
          loadAllData();
          return;
        }

        const savedData = localStorage.getItem('autosave');
        if (savedData) {
          const confirmRestore = confirm('前回の回答データがあります。復元しますか？');
          if (confirmRestore) {
            const answers = JSON.parse(savedData);
            Object.keys(answers).forEach(key => {
              const radio = document.querySelector(`input[name="${key}"][value="${answers[key]}"]`);
              if (radio) radio.checked = true;
            });
          } else {
            localStorage.removeItem('autosave');
          }
        }

        const passwordPattern = /^(?=(?:.*\d){4,})(?=(?:.*[a-zA-Z]){4,}).{8,}$/;
        if (!isAdmin && !passwordPattern.test(password)) {
          alert("パスワードは数字4文字以上・英字4文字以上を含み、合計8文字以上である必要があります。");
          return;
        }
        if (!company) {
          alert("会社名を入力してください。");
          return;
        }
        if (!isAdmin && !username) {
          alert("氏名を入力してください。");
          return;
        }

        if (isAdmin) {
          console.log('管理者ログイン処理');
          const savedPass = localStorage.getItem("adminpass_" + company);
          if (!savedPass) {
            localStorage.setItem("adminpass_" + company, password);
            alert("管理者パスワードを新規登録しました。次回からこのパスワードが必要です。");
            loginForm.style.display = 'none';
            adminPanel.style.display = 'block';
            loadAdminData(company);
            const count = Array.from({length: localStorage.length}, (_, i) => localStorage.key(i))
              .filter(key => key.startsWith(`stress_${company}_`)).length;
            const interviewCount = Array.from({length: localStorage.length}, (_, i) => localStorage.key(i))
              .filter(key => key.startsWith(`stress_${company}_`))
              .map(key => JSON.parse(localStorage.getItem(key)))
              .filter(item => item.interview === '希望する').length;
            const countDiv = document.createElement('div');
            countDiv.style.fontWeight = 'bold';
            countDiv.style.marginBottom = '10px';
            countDiv.textContent = `提出済み人数: ${count}人　／　面談希望者: ${interviewCount}人`;
            adminResults.prepend(countDiv);
          } else if (savedPass === password) {
            loginForm.style.display = 'none';
            adminPanel.style.display = 'block';
            loadAdminData(company);
            const count = Array.from({length: localStorage.length}, (_, i) => localStorage.key(i))
              .filter(key => key.startsWith(`stress_${company}_`)).length;
            const interviewCount = Array.from({length: localStorage.length}, (_, i) => localStorage.key(i))
              .filter(key => key.startsWith(`stress_${company}_`))
              .map(key => JSON.parse(localStorage.getItem(key)))
              .filter(item => item.interview === '希望する').length;
            const countDiv = document.createElement('div');
            countDiv.style.fontWeight = 'bold';
            countDiv.style.marginBottom = '10px';
            countDiv.textContent = `提出済み人数: ${count}人　／　面談希望者: ${interviewCount}人`;
            adminResults.prepend(countDiv);
          } else {
            alert("管理者パスワードが違います。");
            return;
          }
        } else {
          console.log('通常ログイン処理');
          const currentYear = new Date().getFullYear();
          const submissionKey = `stress_${company}_${username}_${currentYear}`;
          if (localStorage.getItem(submissionKey)) {
            alert(`この年度（${currentYear}年）にはすでに提出済みです。次年度までお待ちください。`);
            return;
          }

          loginForm.style.display = 'none';
          checklist.style.display = 'block';
          renderQuestions(sectionA, A_questions, 'A', ['そうだ', 'まあそうだ', 'やや違う', '違う']);
          renderQuestions(sectionB, B_questions, 'B', ['ほとんどなかった', 'ときどきあった', 'しばしばあった', 'ほとんどいつもあった']);
          renderQuestions(sectionC, C_questions, 'C', ['非常に', 'かなり', '多少', '全くない']);
          renderQuestions(sectionD, D_questions, 'D', ['満足', 'まあ満足', 'やや不満足', '不満足']);
          stressForm.dataset.company = company;
          stressForm.dataset.username = username;
          stressForm.dataset.year = currentYear;
        }
      });

      document.getElementById('downloadPDF').addEventListener('click', () => {
        console.log('PDFダウンロード開始');
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const company = stressForm.dataset.company || '不明';
        const username = stressForm.dataset.username || '不明';
        const year = stressForm.dataset.year || '不明';
        const resultText = document.getElementById('result').innerText;

        doc.setFont('helvetica');
        doc.setFontSize(12);
        doc.text(`ストレスチェック結果 (${company} - ${username} - ${year}年度)`, 10, 10);
        doc.text(resultText, 10, 20);
        doc.save(`${company}_${username}_${year}_stress_check.pdf`);
      });

      document.getElementById('exportCSV').addEventListener('click', () => {
        console.log('CSVダウンロード開始');
        const company = document.getElementById('company').value;
        let dataList = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key.startsWith(`stress_${company}_`)) {
            const item = JSON.parse(localStorage.getItem(key));
            dataList.push(item);
          }
        }

        dataList.sort((a, b) => b.totalB - a.totalB);

        const rows = [["氏名", "年度", "会社名", "A合計", "B合計", "C合計", "D合計", "高ストレス", "高ストレス理由", "面談希望", "回答日時"]];
        for (const item of dataList) {
          const highStress = item.highStress ? 'はい' : 'いいえ';
          const interview = item.interview || '';
          rows.push([item.name || '', item.year, item.company || '', item.totalA, item.totalB, item.totalC, item.totalD, highStress, item.highStressReason || '', interview, item.timestamp]);
        }

        const csvContent = rows.map(r => r.join(",")).join("\n");
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${company}_stress_check.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      });

      function loadAdminData(company, highStressOnly = false) {
        console.log(`管理者データ読み込み: ${company}, 高ストレスのみ: ${highStressOnly}`);
        let html = "<table border='1' style='width:100%;border-collapse:collapse;'>" +
                   "<tr><th>氏名</th><th>年度</th><th>A合計</th><th>B合計</th><th>C合計</th><th>D合計</th><th>高ストレス</th><th>高ストレス理由</th><th>面談希望</th><th>回答日時</th></tr>";
        let dataList = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key.startsWith(`stress_${company}_`)) {
            const item = JSON.parse(localStorage.getItem(key));
            if (!highStressOnly || item.highStress) {
              dataList.push(item);
            }
          }
        }

        dataList.sort((a, b) => b.year - a.year || b.totalB - a.totalB);

        for (const item of dataList) {
          const highStress = item.highStress ? '<span class="high-stress">はい</span>' : 'いいえ';
          const interview = item.interview ? '<span class="high-stress">希望する</span>' : '';
          html += `<tr><td>${item.name || ""}</td><td>${item.year}</td><td>${item.totalA}</td><td>${item.totalB}</td><td>${item.totalC}</td><td>${item.totalD}</td><td>${highStress}</td><td>${item.highStressReason || ''}</td><td>${interview}</td><td>${item.timestamp}</td></tr>`;
        }
        html += "</table>";

        html += "<h3>年度ごとの比較</h3>";
        const users = [...new Set(dataList.map(item => item.name))];
        for (const user of users) {
          const userData = dataList.filter(item => item.name === user).sort((a, b) => a.year - b.year);
          if (userData.length > 1) {
            html += `<h4>${user}</h4>`;
            html += "<table border='1' style='width:100%;border-collapse:collapse;'>" +
                    "<tr><th>年度</th><th>A合計</th><th>B合計</th><th>C合計</th><th>D合計</th><th>高ストレス</th></tr>";
            for (const item of userData) {
              const highStress = item.highStress ? '<span class="high-stress">はい</span>' : 'いいえ';
              html += `<tr><td>${item.year}</td><td>${item.totalA}</td><td>${item.totalB}</td><td>${item.totalC}</td><td>${item.totalD}</td><td>${highStress}</td></tr>`;
            }
            html += "</table>";
          }
        }

        adminResults.innerHTML = html;
      }

      function loadAllData(highStressOnly = false) {
        console.log(`全データ読み込み, 高ストレスのみ: ${highStressOnly}`);
        let html = "<table border='1' style='width:100%;border-collapse:collapse;'>" +
                   "<tr><th>会社名</th><th>氏名</th><th>年度</th><th>A合計</th><th>B合計</th><th>C合計</th><th>D合計</th><th>高ストレス</th><th>高ストレス理由</th><th>面談希望</th><th>回答日時</th></tr>";
        let dataList = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key.startsWith("stress_")) {
            const item = JSON.parse(localStorage.getItem(key));
            if (!highStressOnly || item.highStress) {
              dataList.push(item);
            }
          }
        }

        dataList.sort((a, b) => b.year - a.year || b.totalB - a.totalB);

        const rows = [["会社名", "氏名", "年度", "A合計", "B合計", "C合計", "D合計", "高ストレス", "高ストレス理由", "面談希望", "回答日時"]];
        for (const item of dataList) {
          const highStress = item.highStress ? '<span class="high-stress">はい</span>' : 'いいえ';
          const interview = item.interview ? '<span class="high-stress">希望する</span>' : '';
          html += `<tr><td>${item.company}</td><td>${item.name}</td><td>${item.year}</td><td>${item.totalA}</td><td>${item.totalB}</td><td>${item.totalC}</td><td>${item.totalD}</td><td>${highStress}</td><td>${item.highStressReason || ''}</td><td>${interview}</td><td>${item.timestamp}</td></tr>`;
          rows.push([item.company, item.name, item.year, item.totalA, item.totalB, item.totalC, item.totalD, item.highStress ? 'はい' : 'いいえ', item.highStressReason || '', item.interview || '', item.timestamp]);
        }
        html += "</table>";

        html += "<h3>年度ごとの比較</h3>";
        const users = [...new Set(dataList.map(item => item.name))];
        for (const user of users) {
          const userData = dataList.filter(item => item.name === user).sort((a, b) => a.year - b.year);
          if (userData.length > 1) {
            html += `<h4>${user}</h4>`;
            html += "<table border='1' style='width:100%;border-collapse:collapse;'>" +
                    "<tr><th>年度</th><th>A合計</th><th>B合計</th><th>C合計</th><th>D合計</th><th>高ストレス</th></tr>";
            for (const item of userData) {
              const highStress = item.highStress ? '<span class="high-stress">はい</span>' : 'いいえ';
              html += `<tr><td>${item.year}</td><td>${item.totalA}</td><td>${item.totalB}</td><td>${item.totalC}</td><td>${item.totalD}</td><td>${highStress}</td></tr>`;
            }
            html += "</table>";
          }
        }

        masterResults.innerHTML = html;

        document.getElementById('exportAllCSV').onclick = () => {
          console.log('全データCSVダウンロード');
          const csv = rows.map(r => r.join(",")).join("\n");
          const blob = new Blob([csv], { type: 'text/csv' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `全会社_ストレスチェック結果.csv`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        };
      }

      document.getElementById('filterHighStress')?.addEventListener('click', () => {
        console.log('高ストレスフィルタ（管理者）');
        const company = document.getElementById('company').value;
        loadAdminData(company, true);
      });

      document.getElementById('filterHighStressMaster')?.addEventListener('click', () => {
        console.log('高ストレスフィルタ（マスター）');
        loadAllData(true);
      });
    });
  </script>
  <!-- Infolinksスクリプト -->
  <script type="text/javascript">
    var infolinks_pid = 3436126;
    var infolinks_wsid = 0;
  </script>
  <script type="text/javascript" src="//resources.infolinks.com/js/infolinks_main.js"></script>
</body>
</html>
